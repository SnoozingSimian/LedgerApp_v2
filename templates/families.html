<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#0f172a" />
    <title>Families - LedgerApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <script src="/static/dark-mode.js"></script>
    <style>
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #64748b;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }
      
      body.dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
      
      body.dark ::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }

      @supports (padding: max(0px)) {
        body {
          padding-left: env(safe-area-inset-left);
          padding-right: env(safe-area-inset-right);
        }
      }
    </style>
  </head>
  <body class="bg-white dark:bg-slate-900 text-gray-900 dark:text-slate-100 min-h-screen pb-24">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 shadow-sm">
      <div class="px-4 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Families</h1>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="theme-toggle"
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
            aria-label="Toggle dark mode"
          >
            <svg id="sun-icon" class="w-5 h-5 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 18a6 6 0 100-12 6 6 0 000 12zM12 2v4m0 12v4M4.22 4.22l2.83 2.83m4.24 4.24l2.83 2.83M2 12h4m12 0h4m-4.22-7.78l2.83-2.83m-4.24 4.24l2.83-2.83" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
            </svg>
            <svg id="moon-icon" class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
            </svg>
          </button>
          <button
            id="logout-btn"
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors text-red-600 dark:text-red-400"
            aria-label="Logout"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="px-4 py-6 max-w-4xl mx-auto">
      <!-- Active Family Card -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Active Family</h2>
        <div id="active-family-card" class="bg-gradient-to-br from-indigo-500 to-indigo-600 dark:from-indigo-600 dark:to-indigo-700 rounded-lg p-6 text-white shadow-md">
          <p id="active-family-name" class="text-2xl font-bold mb-2">-</p>
          <p class="text-indigo-100 text-sm">Current active family for all transactions</p>
        </div>
      </div>

      <!-- Pending Invites -->
      <div id="pending-invites-section" class="mb-6 hidden">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Pending Invites</h2>
        <div id="pending-invites-container" class="space-y-3">
          <!-- Filled by JS -->
        </div>
      </div>

      <!-- Your Families -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Your Families</h2>
          <button
            id="create-family-btn"
            class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
          >
            + New Family
          </button>
        </div>
        <div id="families-container" class="space-y-3">
          <!-- Filled by JS -->
        </div>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 shadow-2xl z-50 safe-bottom">
      <div class="flex justify-around">
        <a href="/dashboard" class="flex-1 flex flex-col items-center justify-center py-4 text-gray-600 dark:text-slate-400 hover:text-gray-900 dark:hover:text-slate-200 transition-colors active:bg-gray-50 dark:active:bg-slate-700/50">
          <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
          </svg>
          <span class="text-xs font-medium">Home</span>
        </a>
        <a href="/transactions" class="flex-1 flex flex-col items-center justify-center py-4 text-gray-600 dark:text-slate-400 hover:text-gray-900 dark:hover:text-slate-200 transition-colors active:bg-gray-50 dark:active:bg-slate-700/50">
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <span class="text-xs font-medium">Transactions</span>
        </a>
        <a href="/budgets" class="flex-1 flex flex-col items-center justify-center py-4 text-gray-600 dark:text-slate-400 hover:text-gray-900 dark:hover:text-slate-200 transition-colors active:bg-gray-50 dark:active:bg-slate-700/50">
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          <span class="text-xs font-medium">Budgets</span>
        </a>
        <a href="/families" class="flex-1 flex flex-col items-center justify-center py-4 text-blue-600 dark:text-blue-400 border-t-2 border-blue-600 dark:border-blue-400 transition-colors active:bg-blue-50 dark:active:bg-slate-700/50">
          <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
          </svg>
          <span class="text-xs font-medium">Families</span>
        </a>
      </div>
    </nav>

    <!-- Create Family Modal -->
    <div id="create-family-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center">
      <div class="hidden absolute inset-0 bg-black bg-opacity-50" id="modal-backdrop" onclick="closeCreateFamilyModal()"></div>
      <div class="bg-white dark:bg-slate-800 rounded-t-xl sm:rounded-lg w-full sm:max-w-md p-6 sm:shadow-2xl relative z-10 safe-bottom">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Create New Family</h3>
          <button onclick="closeCreateFamilyModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="create-family-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Family Name</label>
            <input
              type="text"
              id="family-name"
              required
              class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="e.g., Smith Family"
            />
          </div>
          <div class="space-y-3">
            <p class="text-sm font-medium text-gray-700 dark:text-slate-300">Import Existing Data?</p>
            <label class="flex items-center">
              <input type="checkbox" id="import-data" class="rounded" />
              <span class="ml-2 text-sm text-gray-700 dark:text-slate-300">Import my current data to this family</span>
            </label>
          </div>
          <div class="flex gap-2 pt-4">
            <button
              type="button"
              onclick="closeCreateFamilyModal()"
              class="flex-1 px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg text-gray-700 dark:text-slate-300 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
            >
              Create
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Family Details Modal -->
    <div id="family-details-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center overflow-y-auto">
      <div class="hidden absolute inset-0 bg-black bg-opacity-50" id="details-modal-backdrop" onclick="closeFamilyDetailsModal()"></div>
      <div class="bg-white dark:bg-slate-800 rounded-t-xl sm:rounded-lg w-full sm:max-w-2xl p-6 sm:shadow-2xl relative z-10 safe-bottom my-auto sm:my-0 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 id="details-family-name" class="text-xl font-semibold text-gray-900 dark:text-white">Family Details</h3>
          <button onclick="closeFamilyDetailsModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Members Section -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-semibold text-gray-900 dark:text-white">Members</h4>
            <button
              id="invite-member-btn"
              onclick="openInviteModal()"
              class="text-blue-600 dark:text-blue-400 text-sm font-medium hover:underline"
            >
              + Invite
            </button>
          </div>
          <div id="members-list" class="space-y-2">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- Pending Invites Section -->
        <div id="pending-invites-details" class="mb-6 hidden">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Pending Invites</h4>
          <div id="pending-invites-list" class="space-y-2">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- Set Active Family -->
        <button
          id="set-active-btn"
          onclick="setActiveFamily()"
          class="w-full mb-3 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors"
        >
          Set as Active Family
        </button>

        <!-- Delete Family -->
        <button
          id="delete-family-btn"
          onclick="deleteFamily()"
          class="w-full px-4 py-2 border border-red-300 dark:border-red-600 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
        >
          Delete Family
        </button>
      </div>
    </div>

    <!-- Invite Member Modal -->
    <div id="invite-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center">
      <div class="hidden absolute inset-0 bg-black bg-opacity-50" id="invite-modal-backdrop" onclick="closeInviteModal()"></div>
      <div class="bg-white dark:bg-slate-800 rounded-t-xl sm:rounded-lg w-full sm:max-w-md p-6 sm:shadow-2xl relative z-10 safe-bottom">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Invite Member</h3>
          <button onclick="closeInviteModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="invite-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Email Address</label>
            <input
              type="email"
              id="invite-email"
              required
              class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="person@example.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Role</label>
            <select
              id="invite-role"
              class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="member">Member</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="flex gap-2 pt-4">
            <button
              type="button"
              onclick="closeInviteModal()"
              class="flex-1 px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg text-gray-700 dark:text-slate-300 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
            >
              Send Invite
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const API_BASE = "/api";
      let token = localStorage.getItem("token");
      let currentFamilyId = null;

      if (!token) {
        window.location.href = "/login";
      }

      // Theme toggle
      document.getElementById("theme-toggle").addEventListener("click", () => {
        toggleDarkMode();
      });

      function toggleDarkMode() {
        darkModeManager.toggle();
        updateThemeIcons();
      }

      function updateThemeIcons() {
        const sunIcon = document.getElementById("sun-icon");
        const moonIcon = document.getElementById("moon-icon");
        
        if (darkModeManager.isDarkMode) {
          sunIcon.classList.remove("hidden");
          moonIcon.classList.add("hidden");
        } else {
          sunIcon.classList.add("hidden");
          moonIcon.classList.remove("hidden");
        }
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login";
      }

      document.getElementById("logout-btn").addEventListener("click", logout);

      // Create Family
      document.getElementById("create-family-btn").addEventListener("click", () => {
        document.getElementById("create-family-modal").classList.remove("hidden");
        document.getElementById("modal-backdrop").classList.remove("hidden");
      });

      function closeCreateFamilyModal() {
        document.getElementById("create-family-modal").classList.add("hidden");
        document.getElementById("modal-backdrop").classList.add("hidden");
      }

      document.getElementById("create-family-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const familyName = document.getElementById("family-name").value;
        const importData = document.getElementById("import-data").checked;

        try {
          const response = await fetch(`${API_BASE}/families`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              name: familyName,
              import_existing_data: importData,
            }),
          });

          if (response.ok) {
            closeCreateFamilyModal();
            document.getElementById("family-name").value = "";
            document.getElementById("import-data").checked = false;
            loadFamilies();
          } else {
            alert("Failed to create family");
          }
        } catch (error) {
          console.error("Error creating family:", error);
          alert("Error creating family");
        }
      });

      // Invite Member
      function openInviteModal() {
        document.getElementById("invite-modal").classList.remove("hidden");
        document.getElementById("invite-modal-backdrop").classList.remove("hidden");
      }

      function closeInviteModal() {
        document.getElementById("invite-modal").classList.add("hidden");
        document.getElementById("invite-modal-backdrop").classList.add("hidden");
      }

      document.getElementById("invite-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("invite-email").value;
        const role = document.getElementById("invite-role").value;

        try {
          const response = await fetch(`${API_BASE}/families/${currentFamilyId}/members/invite`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              invited_email: email,
              role: role,
            }),
          });

          if (response.ok) {
            closeInviteModal();
            document.getElementById("invite-email").value = "";
            document.getElementById("invite-role").value = "member";
            loadFamilyDetails(currentFamilyId);
          } else {
            const error = await response.json();
            alert(error.detail || "Failed to send invite");
          }
        } catch (error) {
          console.error("Error sending invite:", error);
          alert("Error sending invite");
        }
      });

      // Family Details Modal
      async function openFamilyDetails(familyId) {
        currentFamilyId = familyId;
        document.getElementById("family-details-modal").classList.remove("hidden");
        document.getElementById("details-modal-backdrop").classList.remove("hidden");
        await loadFamilyDetails(familyId);
      }

      function closeFamilyDetailsModal() {
        document.getElementById("family-details-modal").classList.add("hidden");
        document.getElementById("details-modal-backdrop").classList.add("hidden");
        currentFamilyId = null;
      }

      async function loadFamilyDetails(familyId) {
        try {
          const response = await fetch(`${API_BASE}/families/${familyId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const family = await response.json();
            document.getElementById("details-family-name").textContent = family.name;

            // Load members
            const membersList = document.getElementById("members-list");
            membersList.innerHTML = "";
            family.members.forEach((member) => {
              const memberDiv = document.createElement("div");
              memberDiv.className = "flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700 rounded-lg";
              memberDiv.innerHTML = `
                <div>
                  <p class="font-medium text-gray-900 dark:text-white">${member.user.full_name}</p>
                  <p class="text-xs text-gray-600 dark:text-slate-400">${member.user.email}</p>
                </div>
                <span class="text-xs px-2 py-1 rounded-full ${member.role === 'admin' ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400'}">${member.role}</span>
              `;
              membersList.appendChild(memberDiv);
            });

            // Load pending invites
            const invitesResponse = await fetch(`${API_BASE}/families/${familyId}/invites`, {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (invitesResponse.ok) {
              const invites = await invitesResponse.json();
              if (invites.length > 0) {
                document.getElementById("pending-invites-details").classList.remove("hidden");
                const invitesList = document.getElementById("pending-invites-list");
                invitesList.innerHTML = "";
                invites.forEach((invite) => {
                  const inviteDiv = document.createElement("div");
                  inviteDiv.className = "flex justify-between items-center p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-900/50 rounded-lg";
                  inviteDiv.innerHTML = `
                    <div>
                      <p class="font-medium text-gray-900 dark:text-white">${invite.invited_email}</p>
                      <p class="text-xs text-gray-600 dark:text-slate-400">Pending...</p>
                    </div>
                    <button
                      onclick="cancelInvite(${familyId}, ${invite.id})"
                      class="text-xs px-2 py-1 rounded bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
                    >
                      Cancel
                    </button>
                  `;
                  invitesList.appendChild(inviteDiv);
                });
              } else {
                document.getElementById("pending-invites-details").classList.add("hidden");
              }
            }
          }
        } catch (error) {
          console.error("Error loading family details:", error);
        }
      }

      async function setActiveFamily() {
        try {
          const response = await fetch(`${API_BASE}/families/${currentFamilyId}/set-active`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            closeFamilyDetailsModal();
            loadFamilies();
          } else {
            alert("Failed to set active family");
          }
        } catch (error) {
          console.error("Error setting active family:", error);
        }
      }

      async function deleteFamily() {
        if (confirm("Are you sure you want to delete this family? This action cannot be undone.")) {
          try {
            const response = await fetch(`${API_BASE}/families/${currentFamilyId}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });

            if (response.ok) {
              closeFamilyDetailsModal();
              loadFamilies();
            } else {
              alert("Failed to delete family");
            }
          } catch (error) {
            console.error("Error deleting family:", error);
          }
        }
      }

      async function cancelInvite(familyId, inviteId) {
        if (confirm("Cancel this invite?")) {
          try {
            const response = await fetch(`${API_BASE}/families/${familyId}/invites/${inviteId}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });

            if (response.ok) {
              loadFamilyDetails(familyId);
            } else {
              alert("Failed to cancel invite");
            }
          } catch (error) {
            console.error("Error canceling invite:", error);
          }
        }
      }

      // Load Families
      async function loadFamilies() {
        try {
          // Load user's families
          const familiesResponse = await fetch(`${API_BASE}/families`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (familiesResponse.ok) {
            const families = await familiesResponse.json();
            const container = document.getElementById("families-container");
            container.innerHTML = "";

            families.forEach((family) => {
              const familyDiv = document.createElement("div");
              familyDiv.className = "p-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg hover:shadow-md dark:hover:shadow-lg dark:hover:shadow-slate-900/50 cursor-pointer transition-all";
              familyDiv.onclick = () => openFamilyDetails(family.id);
              familyDiv.innerHTML = `
                <div class="flex justify-between items-start">
                  <div>
                    <p class="font-semibold text-gray-900 dark:text-white">${family.name}</p>
                    <p class="text-xs text-gray-600 dark:text-slate-400 mt-1">${family.members.length} members</p>
                  </div>
                  <svg class="w-5 h-5 text-gray-400 dark:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              `;
              container.appendChild(familyDiv);
            });
          }

          // Load active family
          const activeResponse = await fetch(`${API_BASE}/user/active-family`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (activeResponse.ok) {
            const activeFamily = await activeResponse.json();
            document.getElementById("active-family-name").textContent = activeFamily.name;
          }

          // Load pending invites
          const invitesResponse = await fetch(`${API_BASE}/user/pending-invites`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (invitesResponse.ok) {
            const invites = await invitesResponse.json();
            if (invites.length > 0) {
              document.getElementById("pending-invites-section").classList.remove("hidden");
              const container = document.getElementById("pending-invites-container");
              container.innerHTML = "";

              invites.forEach((invite) => {
                const inviteDiv = document.createElement("div");
                inviteDiv.className = "p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-900/50 rounded-lg";
                inviteDiv.innerHTML = `
                  <p class="font-semibold text-gray-900 dark:text-white mb-1">${invite.family.name}</p>
                  <p class="text-xs text-gray-600 dark:text-slate-400 mb-3">You've been invited as a ${invite.role}</p>
                  <div class="flex gap-2">
                    <button
                      onclick="acceptInvite('${invite.token}')"
                      class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors"
                    >
                      Accept
                    </button>
                    <button
                      onclick="declineInvite('${invite.token}')"
                      class="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-slate-300 text-sm rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
                    >
                      Decline
                    </button>
                  </div>
                `;
                container.appendChild(inviteDiv);
              });
            } else {
              document.getElementById("pending-invites-section").classList.add("hidden");
            }
          }
        } catch (error) {
          console.error("Error loading families:", error);
          if (error.status === 401) {
            localStorage.removeItem("token");
            window.location.href = "/login";
          }
        }
      }

      async function acceptInvite(token) {
        try {
          // First get invite details
          const getResponse = await fetch(`${API_BASE}/invites/${token}/accept`, {
            method: "POST",
          });

          if (getResponse.ok) {
            // Then confirm with auth
            const confirmResponse = await fetch(`${API_BASE}/invites/${token}/accept/confirm`, {
              method: "POST",
              headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
            });

            if (confirmResponse.ok) {
              loadFamilies();
              alert("Invite accepted!");
            } else {
              alert("Failed to accept invite");
            }
          }
        } catch (error) {
          console.error("Error accepting invite:", error);
        }
      }

      function declineInvite(token) {
        // For now, just reload families (invite expires naturally)
        loadFamilies();
      }

      // Initialize
      updateThemeIcons();
      loadFamilies();
    </script>
  </body>
</html>
